%
% Copyright (C) 2019,2020 The LaTeX3 Project
%

\documentclass{minimal}
\input{regression-test}

\RequirePackage[enable-debug]{expl3}
\ExplSyntaxOn
\debug_on:n { check-declarations , deprecation }
\ExplSyntaxOff

\START
\AUTHOR{Phelype Oleinik}

\ExplSyntaxOn

\OMIT
\intarray_new:Nn \TESTintarrayA { 256 }
\intarray_new:Nn \TESTintarrayB { 256 }
\cs_new:Npn \SAVECATCODES #1
  {
    \int_step_inline:nnn { 1 } { 256 }
      {
        \intarray_gset:Nnn #1 {##1}
          { \char_value_catcode:n {##1-1} }
      }
  }
\tl_new:N \l__test_tl
\prg_new_protected_conditional:Npnn \intarray_if_eq:NN #1 #2 { TF }
  {
    \tl_clear:N \l__test_tl
    \int_step_inline:nnn { 1 } { 256 }
      {
        \int_compare:nNnF
          { \intarray_item:Nn #1 {##1} }
            =
          { \intarray_item:Nn #2 {##1} }
          {
            \tl_put_right:Nx \l__test_tl
              {
                '\char_generate:nn { ##1 - 1 } { 12 }'
                ( \intarray_item:Nn #1 {##1} != \intarray_item:Nn #2 {##1}) ~
              }
          }
      }
    \tl_if_empty:NTF \l__test_tl
      { \prg_return_true: }
      { \prg_return_false: }
  }
\cs_new_eq:NN \IntarrayIfEqTF \intarray_if_eq:NNTF
\TIMO

\TEST { cctab_begin / code~in~iniTeX }
  {
    \errorstopmode
    \cctab_begin:N \c_code_cctab
      \SAVECATCODES \TESTintarrayA
    \cctab_end:
    %
    \cctab_begin:N \c_initex_cctab
      \cctab_begin:N \c_code_cctab
        \SAVECATCODES \TESTintarrayB
      \cctab_end:
    \cctab_end:
    \IntarrayIfEqTF \TESTintarrayA \TESTintarrayB
      { \TYPE { OK } } { \TYPE { Sob~T_T~\l__test_tl } }
  }

\TEST { cctab_begin / iniTeX~in~code }
  {
    \cctab_begin:N \c_initex_cctab
      \SAVECATCODES \TESTintarrayA
    \cctab_end:
    %
    \cctab_begin:N \c_code_cctab
      \cctab_begin:N \c_initex_cctab
        \SAVECATCODES \TESTintarrayB
      \cctab_end:
    \cctab_end:
    \IntarrayIfEqTF \TESTintarrayA \TESTintarrayB
      { \TYPE { OK } } { \TYPE { Sob~T_T~\l__test_tl } }
  }

\TEST { cctab_begin / str~in~document }
  {
    \cctab_begin:N \c_str_cctab
      \SAVECATCODES \TESTintarrayA
    \cctab_end:
    %
    \cctab_begin:N \c_document_cctab
      \cctab_begin:N \c_str_cctab
        \SAVECATCODES \TESTintarrayB
      \cctab_end:
    \cctab_end:
    \IntarrayIfEqTF \TESTintarrayA \TESTintarrayB
      { \TYPE { OK } } { \TYPE { Sob~T_T~\l__test_tl } }
  }

\TEST { cctab_begin / document~in~str }
  {
    \cctab_begin:N \c_document_cctab
      \SAVECATCODES \TESTintarrayA
    \cctab_end:
    %
    \cctab_begin:N \c_str_cctab
      \cctab_begin:N \c_document_cctab
        \SAVECATCODES \TESTintarrayB
      \cctab_end:
    \cctab_end:
    \IntarrayIfEqTF \TESTintarrayA \TESTintarrayB
      { \TYPE { OK } } { \TYPE { Sob~T_T~\l__test_tl } }
  }


\TEST { cctab_select / document~in~str }
  {
    \group_begin:
      \cctab_select:N \c_document_cctab
      \SAVECATCODES \TESTintarrayA
    \group_end:
    %
    \group_begin:
      \cctab_select:N \c_str_cctab
      \cctab_select:N \c_document_cctab
        \SAVECATCODES \TESTintarrayB
    \group_end:
    \IntarrayIfEqTF \TESTintarrayA \TESTintarrayB
      { \TYPE { OK } } { \TYPE { Sob~T_T~\l__test_tl } }
  }

\ExplSyntaxOff

\END
